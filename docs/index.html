<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>This is April - Fashion Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff6b6b;
            --secondary-color: #f5f5f5;
            --dark-color: #222831;
            --light-color: #ffffff;
            --accent-color: #4a154b;
            --border-color: #e0e0e0;
            --success-color: #00b894;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-color);
            color: var(--dark-color);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            height: 100vh;
        }
        
        .chat-container {
            flex: 1;
            background-color: var(--light-color);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin-right: 20px;
            transition: all 0.3s ease;
        }
        
        .product-container {
            flex: 1.5;
            background-color: var(--light-color);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .chat-header {
            padding: 15px 20px;
            background-color: var(--accent-color);
            color: var(--light-color);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .chat-header img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            border-radius: 50%;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        
        .message {
            margin-bottom: 20px;
            max-width: 85%;
            position: relative;
        }
        
        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 1.5;
        }
        
        .user-message {
            margin-left: auto;
        }
        
        .user-message .message-bubble {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            margin-right: auto;
        }
        
        .bot-message .message-bubble {
            background-color: white;
            color: var(--dark-color);
            border-bottom-left-radius: 4px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: white;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 30px;
            outline: none;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            transition: border 0.3s ease;
        }
        
        .chat-input input:focus {
            border-color: var(--primary-color);
        }
        
        .chat-input button {
            padding: 0;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }
        
        .chat-input button:hover {
            background-color: #ff5252;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .product-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-match {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--success-color);
            color: white;
            padding: 5px 10px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .product-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        
        .product-brand {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .product-price {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .product-description {
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }
        
        .product-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .meta-item {
            background-color: #f1f1f1;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #555;
        }
        
        .product-action {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        
        .product-action button {
            flex: 1;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .product-action button:hover {
            background-color: #ff5252;
        }
        
        .product-action a {
            padding: 12px;
            background-color: var(--accent-color);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            text-align: center;
            flex: 1;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .view-btn {
            width: 100%;
        }
        
        .typing-indicator {
            display: flex;
            padding: 15px;
            margin-bottom: 20px;
            width: auto;
            align-self: flex-start;
        }
        
        .typing-indicator span {
            width: 10px;
            height: 10px;
            background-color: #b6b6b6;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.5s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        /* Animation for product cards */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive design */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                height: auto;
                padding: 10px;
            }
            
            .chat-container {
                max-width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
                height: 500px;
            }
            
            .product-container {
                max-height: 600px;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .chat-container {
                height: 400px;
            }
            
            .product-image {
                height: 200px;
            }
        }

        .api-key-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ced4da;
        }

        .api-key-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .api-key-section input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .api-key-section button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
        }

        .api-key-section button:hover {
            background-color: #3c1d3e;
        }

        .api-status {
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <h2>Fashion Assistant</h2>
            </div>
            <div class="api-key-section">
                <h3>OpenAI API Key</h3>
                <input type="password" id="apiKeyInput" placeholder="Enter your OpenAI API key">
                <button id="saveApiKey">Save Key</button>
                <div id="apiStatus" class="api-status"></div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here -->
            </div>
            <div class="chat-input">
                <input type="text" id="userInput" placeholder="Tanya tentang fashion kesukaanmu...">
                <button id="sendButton">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="product-container" id="productDetails">
            <h2>Rekomendasi Fashion</h2>
            <p>Chat dengan April untuk mendapatkan rekomendasi fashion yang sesuai dengan gaya dan preferensimu.</p>
            
            <!-- Products will be displayed here -->
            <div class="product-grid" id="productGrid"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const productGrid = document.getElementById('productGrid');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const saveApiKeyButton = document.getElementById('saveApiKey');
            const apiStatus = document.getElementById('apiStatus');
            
            // Load API key from localStorage if available
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                apiStatus.textContent = "API key loaded from storage";
                apiStatus.style.color = "green";
            }
            
            // Save API key to localStorage
            saveApiKeyButton.addEventListener('click', () => {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem('openai_api_key', apiKey);
                    apiStatus.textContent = "API key saved successfully";
                    apiStatus.style.color = "green";
                } else {
                    apiStatus.textContent = "Please enter a valid API key";
                    apiStatus.style.color = "red";
                }
            });

            // Session management - create a new session on page load
            let sessionId = generateUUID();
            let fashionData = [];
            let userPreferences = {
                "occasion": null,
                "budget": null,
                "clothing_type": null,
                "material": null,
                "size": null,
                "season": null,
                "style": null
            };
            
            // Load fashion data
            fetch('fashion_data.json')
                .then(response => response.json())
                .then(data => {
                    fashionData = data;
                    console.log('Fashion data loaded:', fashionData.length, 'products');
                })
                .catch(error => {
                    console.error('Error loading fashion data:', error);
                });
            
            // Add initial bot message
            addMessage("Halo! Saya April, Personal stylist kamu dari This is April. Kamu mau cari pakaian untuk occasion apa nih? Casual, formal, atau acara khusus?", false);
            
            function addMessage(message, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                messageDiv.classList.add(isUser ? 'user-message' : 'bot-message');
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.classList.add('message-bubble');
                bubbleDiv.textContent = message;
                
                messageDiv.appendChild(bubbleDiv);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function addTypingIndicator() {
                const indicatorDiv = document.createElement('div');
                indicatorDiv.classList.add('typing-indicator', 'message', 'bot-message');
                indicatorDiv.innerHTML = '<span></span><span></span><span></span>';
                indicatorDiv.id = 'typingIndicator';
                chatMessages.appendChild(indicatorDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            function displayProducts(products) {
                productGrid.innerHTML = '';
                
                if (!products || products.length === 0) {
                    return;
                }
                
                // Add flash effect to product container
                const productContainer = document.querySelector('.product-container');
                productContainer.style.transition = 'background-color 0.3s ease';
                productContainer.style.backgroundColor = '#fff8e1'; // Soft highlight color
                
                // Return to normal color after 500ms
                setTimeout(() => {
                    productContainer.style.backgroundColor = 'var(--light-color)';
                }, 500);
                
                console.log("Displaying products:", products.map(p => p.title));
                
                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.classList.add('product-card');
                    productCard.dataset.productId = product.title;
                    
                    // Add fade-in animation
                    productCard.style.opacity = '0';
                    productCard.style.animation = 'fadeIn 0.5s forwards';
                    
                    // Add match percentage if available
                    if (product.match_percentage) {
                        const matchSpan = document.createElement('div');
                        matchSpan.classList.add('product-match');
                        matchSpan.textContent = `${product.match_percentage}% Match`;
                        productCard.appendChild(matchSpan);
                        console.log(`Product ${product.title} match percentage: ${product.match_percentage}%`);
                    } else {
                        console.log(`Product ${product.title} has no match percentage`);
                    }
                    
                    // Add product image if available
                    if (product.metadata && product.metadata.images && product.metadata.images.length > 0) {
                        const img = document.createElement('img');
                        img.src = product.metadata.images[0];
                        img.alt = product.title;
                        img.classList.add('product-image');
                        productCard.appendChild(img);
                    } else {
                        // Placeholder image if no image is available
                        const imgPlaceholder = document.createElement('div');
                        imgPlaceholder.classList.add('product-image');
                        imgPlaceholder.style.backgroundColor = '#f0f0f0';
                        imgPlaceholder.style.display = 'flex';
                        imgPlaceholder.style.alignItems = 'center';
                        imgPlaceholder.style.justifyContent = 'center';
                        imgPlaceholder.textContent = 'No Image Available';
                        productCard.appendChild(imgPlaceholder);
                    }
                    
                    const productInfo = document.createElement('div');
                    productInfo.classList.add('product-info');
                    
                    // Product title
                    const title = document.createElement('div');
                    title.classList.add('product-title');
                    title.textContent = product.title;
                    productInfo.appendChild(title);
                    
                    // Product brand
                    const brand = document.createElement('div');
                    brand.classList.add('product-brand');
                    brand.textContent = product.brand;
                    productInfo.appendChild(brand);
                    
                    // Product price
                    const price = document.createElement('div');
                    price.classList.add('product-price');
                    price.textContent = `${product.price.currency} ${product.price.amount.toLocaleString()}`;
                    productInfo.appendChild(price);
                    
                    // Product description
                    const description = document.createElement('div');
                    description.classList.add('product-description');
                    description.textContent = product.short_description;
                    productInfo.appendChild(description);
                    
                    // Product meta info (materials)
                    if (product.materials && product.materials.length > 0) {
                        const meta = document.createElement('div');
                        meta.classList.add('product-meta');
                        
                        product.materials.forEach(material => {
                            const metaItem = document.createElement('div');
                            metaItem.classList.add('meta-item');
                            metaItem.textContent = `${material.name} (${material.percentage}%)`;
                            meta.appendChild(metaItem);
                        });
                        
                        productInfo.appendChild(meta);
                    }
                    
                    // Product actions
                    const actions = document.createElement('div');
                    actions.classList.add('product-action');
                    
                    if (product.url) {
                        const viewLink = document.createElement('a');
                        viewLink.href = product.url;
                        viewLink.target = '_blank';
                        viewLink.textContent = 'Lihat';
                        viewLink.classList.add('view-btn');
                        actions.appendChild(viewLink);
                    }
                    
                    productInfo.appendChild(actions);
                    productCard.appendChild(productInfo);
                    
                    productGrid.appendChild(productCard);
                });
            }
            
            // Simple function to extract preferences from text
            function extractPreferences(text) {
                const preferences = {};
                
                // Extract clothing type
                const clothingTypes = ['top', 'pants', 'dress', 'skirt', 'outerwear', 'celana', 'kemeja', 'kaos', 'rok'];
                for (const type of clothingTypes) {
                    if (text.toLowerCase().includes(type)) {
                        preferences.clothing_type = type;
                        break;
                    }
                }
                
                // Extract occasion
                const occasions = ['formal', 'casual', 'party', 'sport', 'kantor', 'office', 'pesta'];
                for (const occasion of occasions) {
                    if (text.toLowerCase().includes(occasion)) {
                        preferences.occasion = occasion;
                        break;
                    }
                }
                
                // Extract material
                const materials = ['cotton', 'katun', 'polyester', 'wool', 'denim', 'jeans', 'knit', 'rajut', 'silk', 'sutra'];
                for (const material of materials) {
                    if (text.toLowerCase().includes(material)) {
                        preferences.material = material;
                        break;
                    }
                }
                
                // Extract budget
                const budgetRegex = /(\d+)\s*(rb|ribu|k|ratus|juta)/i;
                const budgetMatch = text.match(budgetRegex);
                if (budgetMatch) {
                    let budget = parseInt(budgetMatch[1]);
                    const unit = budgetMatch[2].toLowerCase();
                    
                    if (unit === 'rb' || unit === 'ribu' || unit === 'k') {
                        budget *= 1000;
                    } else if (unit === 'juta') {
                        budget *= 1000000;
                    }
                    
                    preferences.budget = budget;
                }
                
                return preferences;
            }
            
            // Simple preference-based search
            function searchProducts(query, preferences) {
                if (!fashionData || fashionData.length === 0) {
                    return [];
                }
                
                // Filter by preferences if available
                let results = [...fashionData];
                
                // Filter by clothing type
                if (preferences.clothing_type) {
                    const filteredByType = results.filter(product => {
                        const productText = `${product.title} ${product.short_description} ${product.full_description}`;
                        if (product.categories) {
                            return product.categories.some(cat => cat.toLowerCase().includes(preferences.clothing_type.toLowerCase())) ||
                                   productText.toLowerCase().includes(preferences.clothing_type.toLowerCase());
                        }
                        return productText.toLowerCase().includes(preferences.clothing_type.toLowerCase());
                    });
                    
                    if (filteredByType.length > 0) {
                        results = filteredByType;
                    }
                }
                
                // Filter by occasion
                if (preferences.occasion) {
                    const filteredByOccasion = results.filter(product => {
                        const productText = `${product.title} ${product.short_description} ${product.full_description}`;
                        if (product.tags) {
                            return product.tags.some(tag => tag.toLowerCase().includes(preferences.occasion.toLowerCase())) ||
                                   productText.toLowerCase().includes(preferences.occasion.toLowerCase());
                        }
                        return productText.toLowerCase().includes(preferences.occasion.toLowerCase());
                    });
                    
                    if (filteredByOccasion.length > 0) {
                        results = filteredByOccasion;
                    }
                }
                
                // Filter by material
                if (preferences.material) {
                    const filteredByMaterial = results.filter(product => {
                        if (product.materials) {
                            return product.materials.some(mat => mat.name.toLowerCase().includes(preferences.material.toLowerCase()));
                        }
                        const productText = `${product.title} ${product.short_description} ${product.full_description}`;
                        return productText.toLowerCase().includes(preferences.material.toLowerCase());
                    });
                    
                    if (filteredByMaterial.length > 0) {
                        results = filteredByMaterial;
                    }
                }
                
                // Filter by budget
                if (preferences.budget) {
                    const filteredByBudget = results.filter(product => 
                        product.price && product.price.amount <= preferences.budget
                    );
                    
                    if (filteredByBudget.length > 0) {
                        results = filteredByBudget;
                    }
                }
                
                // Calculate match percentages
                results.forEach(product => {
                    let matchScore = 0;
                    let criteriaCount = 0;
                    
                    // Clothing type match
                    if (preferences.clothing_type) {
                        criteriaCount++;
                        const productText = `${product.title} ${product.short_description} ${product.full_description}`;
                        if (product.categories && product.categories.some(cat => cat.toLowerCase().includes(preferences.clothing_type.toLowerCase())) ||
                            productText.toLowerCase().includes(preferences.clothing_type.toLowerCase())) {
                            matchScore++;
                        }
                    }
                    
                    // Occasion match
                    if (preferences.occasion) {
                        criteriaCount++;
                        const productText = `${product.title} ${product.short_description} ${product.full_description}`;
                        if (product.tags && product.tags.some(tag => tag.toLowerCase().includes(preferences.occasion.toLowerCase())) ||
                            productText.toLowerCase().includes(preferences.occasion.toLowerCase())) {
                            matchScore++;
                        }
                    }
                    
                    // Material match
                    if (preferences.material) {
                        criteriaCount++;
                        if (product.materials && product.materials.some(mat => mat.name.toLowerCase().includes(preferences.material.toLowerCase()))) {
                            matchScore++;
                        } else {
                            const productText = `${product.title} ${product.short_description} ${product.full_description}`;
                            if (productText.toLowerCase().includes(preferences.material.toLowerCase())) {
                                matchScore++;
                            }
                        }
                    }
                    
                    // Budget match
                    if (preferences.budget) {
                        criteriaCount++;
                        if (product.price && product.price.amount <= preferences.budget) {
                            matchScore++;
                        }
                    }
                    
                    // Calculate match percentage
                    if (criteriaCount > 0) {
                        product.match_percentage = Math.floor((matchScore / criteriaCount) * 100);
                    }
                });
                
                // Sort by match percentage (if available) or just return filtered results
                results.sort((a, b) => (b.match_percentage || 0) - (a.match_percentage || 0));
                
                // Return top 3 results
                return results.slice(0, 3);
            }
            
            async function sendMessage(message = null) {
                // Get message from input or parameter
                const userMessage = message || userInput.value.trim();
                if (!userMessage) return;
                
                // Clear input
                if (!message) userInput.value = '';
                
                // Add user message to chat
                addMessage(userMessage, true);
                
                // Show typing indicator
                addTypingIndicator();
                
                // Get API key
                const apiKey = localStorage.getItem('openai_api_key');
                if (!apiKey) {
                    removeTypingIndicator();
                    addMessage("Kamu belum memasukkan API key OpenAI. Silakan masukkan API key terlebih dahulu untuk mendapatkan rekomendasi fashion yang lebih baik.", false);
                    return;
                }
                
                try {
                    // Update preferences based on user message
                    const newPreferences = extractPreferences(userMessage);
                    for (const [key, value] of Object.entries(newPreferences)) {
                        if (value) {
                            userPreferences[key] = value;
                        }
                    }
                    
                    // Search for products based on preferences
                    const products = searchProducts(userMessage, userPreferences);
                    
                    // Count primary preferences (occasion, clothing_type, material, budget)
                    const primaryPrefs = ['occasion', 'clothing_type', 'material', 'budget'];
                    const primaryPrefCount = primaryPrefs.filter(pref => userPreferences[pref]).length;
                    
                    // Generate response using OpenAI API
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo",
                            messages: [
                                {
                                    "role": "system", 
                                    "content": "You are April, a helpful, warm and enthusiastic fashion stylist who works for 'This is April' fashion brand. You chat in a conversational Bahasa Indonesia style like a friend would. Your personality is friendly, enthusiastic and you make people feel comfortable with your natural conversation style. Use casual, warm language with natural expressions like 'nih', 'dong', 'sih', 'banget', etc. where appropriate to sound authentic. Focus on helping users find products based on OCCASION, CLOTHING TYPE, MATERIAL, and BUDGET as the main criteria."
                                },
                                {
                                    "role": "user",
                                    "content": `User message: "${userMessage}"
                                    
                                    Current user preferences:
                                    - Occasion: ${userPreferences.occasion || 'Not specified'}
                                    - Clothing type: ${userPreferences.clothing_type || 'Not specified'}
                                    - Material: ${userPreferences.material || 'Not specified'}
                                    - Budget: ${userPreferences.budget ? `IDR ${userPreferences.budget.toLocaleString()}` : 'Not specified'}
                                    
                                    ${primaryPrefCount >= 2 && products.length > 0 ? 
                                      `Found ${products.length} products that match the preferences. Here are the details:
                                      
                                      ${products.map((product, idx) => 
                                        `Product ${idx+1}: ${product.title}
                                        Brand: ${product.brand}
                                        Price: ${product.price.currency} ${product.price.amount.toLocaleString()}
                                        Materials: ${product.materials ? product.materials.map(m => `${m.name} (${m.percentage}%)`).join(', ') : 'Not specified'}
                                        Description: ${product.short_description}`
                                      ).join('\n\n')}` 
                                      : 
                                      `Need more information about their preferences. Currently have ${primaryPrefCount} out of 4 primary preferences.`}
                                    
                                    ${primaryPrefCount < 4 ? 
                                      `Missing preferences: ${primaryPrefs.filter(pref => !userPreferences[pref]).join(', ')}. 
                                      Please ask ONE question to get ONE of the missing preferences in a natural conversational way.` 
                                      : ''}`
                                }
                            ],
                            temperature: 0.8,
                            max_tokens: 300
                        })
                    });
                    
                    const responseData = await response.json();
                    
                    // Remove typing indicator
                    removeTypingIndicator();
                    
                    if (responseData.choices && responseData.choices.length > 0) {
                        const botResponse = responseData.choices[0].message.content;
                        addMessage(botResponse, false);
                        
                        // Display products if we have enough preferences
                        if (primaryPrefCount >= 2 && products.length > 0) {
                            displayProducts(products);
                        }
                    } else {
                        throw new Error('Invalid response from OpenAI API');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    removeTypingIndicator();
                    addMessage('Maaf, terjadi kesalahan. Silakan coba lagi.', false);
                }
            }
            
            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0,
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            
            sendButton.addEventListener('click', () => sendMessage());
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html> 